---
# === ConfigMap: Velocity設定 ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: paper-velocity-config
data:
  paper-global.yml: |
    proxies:
      velocity:
        enabled: true
        online-mode: true
        secret: "tak-pipeline-secret-123"

---
# === 1. ロビーサーバー (2GB) ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-lobby
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-path
  resources: { requests: { storage: 5Gi } }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-lobby
spec:
  replicas: 1
  selector: { matchLabels: { app: mc-lobby } }
  template:
    metadata:
      labels: { app: mc-lobby }
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        # メインコンテナ: Minecraft Server
        - name: minecraft
          image: itzg/minecraft-server
          env:
            - { name: EULA, value: "TRUE" }
            - { name: TYPE, value: "PAPER" }
            - { name: MEMORY, value: "2G" }
            - { name: ONLINE_MODE, value: "FALSE" }
            - { name: ENABLE_QUERY, value: "true" }
          ports:
            - containerPort: 25565
              name: minecraft
          volumeMounts:
            - { mountPath: /data, name: data }
            - mountPath: /config/paper-global.yml
              name: velocity-config
              subPath: paper-global.yml
          resources:
            requests: { memory: "2Gi", cpu: "500m" }
            limits: { memory: "2.5Gi", cpu: "2000m" }
        # サイドカー: mc-monitor
        - name: mc-monitor
          image: itzg/mc-monitor
          args: ["export-for-prometheus"]
          env:
            - name: EXPORT_SERVERS
              value: "localhost:25565"
            - name: DEBUG
              value: "false"
          ports:
            - containerPort: 8080
              name: metrics
          resources:
            requests: { memory: "32Mi", cpu: "10m" }
            limits: { memory: "64Mi", cpu: "100m" }
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: pvc-lobby }
        - name: velocity-config
          configMap: { name: paper-velocity-config }
---
apiVersion: v1
kind: Service
metadata:
  name: svc-lobby
spec:
  selector: { app: mc-lobby }
  ports:
    - port: 25565
      name: minecraft
    - port: 8080
      name: metrics
  type: ClusterIP
---
# Prometheus ServiceMonitor用（オプション）
apiVersion: v1
kind: Service
metadata:
  name: svc-lobby-metrics
  labels:
    app: mc-lobby
    metrics: "true"
spec:
  selector: { app: mc-lobby }
  ports:
    - port: 8080
      name: metrics
      targetPort: 8080
  type: ClusterIP

---
# === 2. サバイバルサーバー (4GB) ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-survival
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-path
  resources: { requests: { storage: 20Gi } }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-survival
spec:
  replicas: 1
  selector: { matchLabels: { app: mc-survival } }
  template:
    metadata:
      labels: { app: mc-survival }
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        # メインコンテナ: Minecraft Server
        - name: minecraft
          image: itzg/minecraft-server
          env:
            - { name: EULA, value: "TRUE" }
            - { name: TYPE, value: "PAPER" }
            - { name: MEMORY, value: "4G" }
            - { name: ONLINE_MODE, value: "FALSE" }
            - { name: ENABLE_QUERY, value: "true" }
          ports:
            - containerPort: 25565
              name: minecraft
          volumeMounts:
            - { mountPath: /data, name: data }
            - mountPath: /config/paper-global.yml
              name: velocity-config
              subPath: paper-global.yml
          resources:
            requests: { memory: "4Gi", cpu: "1000m" }
            limits: { memory: "4.5Gi", cpu: "3000m" }
        # サイドカー: mc-monitor
        - name: mc-monitor
          image: itzg/mc-monitor
          args: ["export-for-prometheus"]
          env:
            - name: EXPORT_SERVERS
              value: "localhost:25565"
            - name: DEBUG
              value: "false"
          ports:
            - containerPort: 8080
              name: metrics
          resources:
            requests: { memory: "32Mi", cpu: "10m" }
            limits: { memory: "64Mi", cpu: "100m" }
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: pvc-survival }
        - name: velocity-config
          configMap: { name: paper-velocity-config }
---
apiVersion: v1
kind: Service
metadata:
  name: svc-survival
spec:
  selector: { app: mc-survival }
  ports:
    - port: 25565
      name: minecraft
    - port: 8080
      name: metrics
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: svc-survival-metrics
  labels:
    app: mc-survival
    metrics: "true"
spec:
  selector: { app: mc-survival }
  ports:
    - port: 8080
      name: metrics
      targetPort: 8080
  type: ClusterIP

---
# === 3. 工業サーバー (8GB) ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-industry
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-path
  resources: { requests: { storage: 30Gi } }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-industry
spec:
  replicas: 1
  selector: { matchLabels: { app: mc-industry } }
  template:
    metadata:
      labels: { app: mc-industry }
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        # メインコンテナ: Minecraft Server
        - name: minecraft
          image: itzg/minecraft-server
          env:
            - { name: EULA, value: "TRUE" }
            - { name: TYPE, value: "PAPER" }
            - { name: MEMORY, value: "8G" }
            - { name: ONLINE_MODE, value: "FALSE" }
            - { name: ENABLE_QUERY, value: "true" }
            # 工業MOD用に調整
            - { name: MAX_TICK_TIME, value: "120000" }
            - { name: VIEW_DISTANCE, value: "8" }
            - { name: SIMULATION_DISTANCE, value: "6" }
          ports:
            - containerPort: 25565
              name: minecraft
          volumeMounts:
            - { mountPath: /data, name: data }
            - mountPath: /config/paper-global.yml
              name: velocity-config
              subPath: paper-global.yml
          resources:
            requests: { memory: "8Gi", cpu: "2000m" }
            limits: { memory: "9Gi", cpu: "4000m" }
        # サイドカー: mc-monitor
        - name: mc-monitor
          image: itzg/mc-monitor
          args: ["export-for-prometheus"]
          env:
            - name: EXPORT_SERVERS
              value: "localhost:25565"
            - name: DEBUG
              value: "false"
          ports:
            - containerPort: 8080
              name: metrics
          resources:
            requests: { memory: "32Mi", cpu: "10m" }
            limits: { memory: "64Mi", cpu: "100m" }
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: pvc-industry }
        - name: velocity-config
          configMap: { name: paper-velocity-config }
---
apiVersion: v1
kind: Service
metadata:
  name: svc-industry
spec:
  selector: { app: mc-industry }
  ports:
    - port: 25565
      name: minecraft
    - port: 8080
      name: metrics
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: svc-industry-metrics
  labels:
    app: mc-industry
    metrics: "true"
spec:
  selector: { app: mc-industry }
  ports:
    - port: 8080
      name: metrics
      targetPort: 8080
  type: ClusterIP






