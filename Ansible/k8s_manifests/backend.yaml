---
# === ConfigMap: Velocity設定 ===
apiVersion: v1
kind: ConfigMap
metadata:
  name: paper-velocity-config
data:
  paper-global.yml: |
    proxies:
      velocity:
        enabled: true
        online-mode: true
        secret: "tak-pipeline-secret-123"

---
# === 1. ロビーサーバー ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-lobby
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-path
  resources: { requests: { storage: 5Gi } }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-lobby
spec:
  replicas: 1
  selector: { matchLabels: { app: mc-lobby } }
  template:
    metadata: { labels: { app: mc-lobby } }
    spec:
      containers:
        - name: minecraft
          image: itzg/minecraft-server
          env:
            - { name: EULA, value: "TRUE" }
            - { name: TYPE, value: "PAPER" }
            - { name: MEMORY, value: "4G" }
            - { name: ONLINE_MODE, value: "FALSE" }
            # AdvancedPortalsプラグインを自動ダウンロード
            - name: SPIGET_RESOURCES
              value: "53051"  # AdvancedPortalsのSpigot Resource ID
          ports: [{ containerPort: 25565 }]
          volumeMounts:
            - { mountPath: /data, name: data }
            - mountPath: /config/paper-global.yml
              name: velocity-config
              subPath: paper-global.yml
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: pvc-lobby }
        - name: velocity-config
          configMap: { name: paper-velocity-config }
---
apiVersion: v1
kind: Service
metadata:
  name: svc-lobby
spec:
  selector: { app: mc-lobby }
  ports: [{ port: 25565 }]
  type: ClusterIP

---
# === 2. サバイバルサーバー ===
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-survival
spec:
  accessModes: ["ReadWriteOnce"]
  storageClassName: local-path
  resources: { requests: { storage: 20Gi } }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-survival
spec:
  replicas: 1
  selector: { matchLabels: { app: mc-survival } }
  template:
    metadata: { labels: { app: mc-survival } }
    spec:
      containers:
        - name: minecraft
          image: itzg/minecraft-server
          env:
            - { name: EULA, value: "TRUE" }
            - { name: TYPE, value: "PAPER" }
            - { name: MEMORY, value: "8G" }
            - { name: ONLINE_MODE, value: "FALSE" }
            # AdvancedPortalsプラグインを自動ダウンロード
            - name: SPIGET_RESOURCES
              value: "53051"
          ports: [{ containerPort: 25565 }]
          volumeMounts:
            - { mountPath: /data, name: data }
            - mountPath: /config/paper-global.yml
              name: velocity-config
              subPath: paper-global.yml
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: pvc-survival }
        - name: velocity-config
          configMap: { name: paper-velocity-config }
---
apiVersion: v1
kind: Service
metadata:
  name: svc-survival
spec:
  selector: { app: mc-survival }
  ports: [{ port: 25565 }]
  type: ClusterIP