# ============================================================
# TAK Pipeline - Services (GKE)
# ============================================================

---
# ============================================================
# Velocity LoadBalancer Service
# ============================================================
# 外部公開用（プレイヤー接続エンドポイント）
apiVersion: v1
kind: Service
metadata:
  name: velocity-lb
  namespace: minecraft
  labels:
    app: velocity
    app.kubernetes.io/component: proxy
    app.kubernetes.io/part-of: tak-pipeline
  annotations:
    # GKE固有のアノテーション
    # 固定IPを使用する場合（Terraformで作成したIP）
    # networking.gke.io/load-balancer-ip-addresses: "tak-minecraft-ip"
    
    # Network Tier（STANDARDでコスト削減、PREMIUMで低遅延）
    cloud.google.com/network-tier: "STANDARD"
spec:
  type: LoadBalancer
  # 外部トラフィックポリシー
  # Local: クライアントIPを保持（推奨）
  # Cluster: ノード間負荷分散
  externalTrafficPolicy: Local
  selector:
    app: velocity
  ports:
    - name: minecraft
      port: 25565        # 外部公開ポート
      targetPort: 25577  # Velocityの実際のポート
      protocol: TCP

---
# ============================================================
# Velocity ClusterIP Service (内部用)
# ============================================================
# クラスター内からのアクセス用
apiVersion: v1
kind: Service
metadata:
  name: velocity
  namespace: minecraft
  labels:
    app: velocity
    app.kubernetes.io/component: proxy
spec:
  type: ClusterIP
  selector:
    app: velocity
  ports:
    - name: minecraft
      port: 25577
      targetPort: 25577

---
# ============================================================
# Lobby ClusterIP Service
# ============================================================
# Velocityからのアクセス用（クラスター内部のみ）
apiVersion: v1
kind: Service
metadata:
  name: lobby
  namespace: minecraft
  labels:
    app: mc-lobby
    app.kubernetes.io/component: lobby
spec:
  type: ClusterIP
  selector:
    app: mc-lobby
  ports:
    - name: minecraft
      port: 25566
      targetPort: 25566
    - name: metrics
      port: 8080
      targetPort: 8080

---
# ============================================================
# Lobby Metrics Service (Prometheus用)
# ============================================================
apiVersion: v1
kind: Service
metadata:
  name: lobby-metrics
  namespace: minecraft
  labels:
    app: mc-lobby
    metrics: "true"
spec:
  type: ClusterIP
  selector:
    app: mc-lobby
  ports:
    - name: metrics
      port: 8080
      targetPort: 8080

---
# ============================================================
# PodMonitor for GKE Managed Prometheus (optional)
# ============================================================
# GKE Managed Prometheusを使用する場合
apiVersion: monitoring.googleapis.com/v1
kind: PodMonitoring
metadata:
  name: minecraft-monitoring
  namespace: minecraft
  labels:
    app.kubernetes.io/part-of: tak-pipeline
spec:
  selector:
    matchLabels:
      app.kubernetes.io/part-of: tak-pipeline
  endpoints:
    - port: metrics
      interval: 30s
      path: /metrics
